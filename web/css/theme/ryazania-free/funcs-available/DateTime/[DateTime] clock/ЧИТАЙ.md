# clock

Запоминаем время и метку. Считаем разницу между метками. Отправляем SQL запрос на каждом вызове, чтобы отследить запросы между метками.

```xml
<cms:call 'clock' memo='Timer init'/>
..
<cms:call 'clock' memo='Timer done' show='1'/>
```

Неограниченное количество меток. Всё пишем в массив-переменную **clock**.

Формат времени — **H:i:s** с миллисекундами.

## Примеры

```xml
<cms:call 'clock' 'поехали' />
<cms:pages limit='3'>
  <cms:call 'clock' "page<cms:show k_count />-fetched" />
</cms:pages>
<cms:call 'clock' 'приехали' show='1'/>
```

↓

```
0001 11:04:53 003 :: поехали
            + 5
0002 11:04:53 008 :: page1-fetched
            + 2
0003 11:04:53 010 :: page2-fetched
            + 2
0004 11:04:53 012 :: page3-fetched
0005 11:04:53 012 :: приехали
```

– печатаем разницу в миллисекундах. Можно и не считать, поставив **diff** в ***0*** —

```
..
<cms:call 'clock' 'complete' show='1' diff='0'/>
```

↓

```
0001 11:02:27 335 :: init
0002 11:02:27 341 :: page1-fetched
0003 11:02:27 345 :: page2-fetched
0004 11:02:27 347 :: page3-fetched
0005 11:02:27 347 :: complete
```

## Параметры

* __memo__ — сообщение-метка
* __show__ — если ***1***, печатаем вывод
* __diff__ — если ***0***, не печатаем разницу времени между вызовами

## Использование

Designed to track tag's time, this function will keep memos and times in a list.

### по-простому

```xml
<cms:call 'clock' memo='Tag :pages start'/>

.. какой-то долгобегущий код ..
<cms:pages masterpage=k_template_name limit='10000' />

<cms:call 'clock' memo='Tag :pages end' show='1'/>
```

### если нужны детали

Выводите **clock** массив напрямую. Структура массива **clock** —

```xml
[
   {
      "step":"0001",
      "memo":"init",
      "ts":1676880555190,
      "ms":"190",
      "date":"11:09:15",
      "diff":""
   }
]
```

– ну или как JSON печатаем –

```xml
<cms:if "<cms:tag_exists 'show_json' />">
  <cms:show_json clock />
<cms:else />
  <cms:show clock as_json='1' />
</cms:if>
```

### SQL query log - лог запросов

Пока часики тикают **clock** отправляет SELECT к базе. Эта чудесная штучка огромную помощь окажет русам, работающим с запросами. Можно посмотреть всё, что было отправлено в базу тегом между метками. Цена всего удовольствия - (~0.1-0.5ms) доля миллисекунды. Ерунда, короче. Вот пример с лога запросов:

```sql
..
..
04:35:40.562114Z	 SELECT * FROM couch_templates WHERE id='40'
04:35:40.563005Z	 SELECT config_form FROM couch_templates WHERE id='40'
04:35:40.563570Z	 SELECT config_list FROM couch_templates WHERE id='40'
04:35:40.570419Z	 SELECT "------------ CLOCK :: init --------"
04:35:40.570967Z	 SELECT * FROM couch_templates WHERE name='run.php'
04:35:40.571635Z	 SELECT count(p.id) as cnt FROM couch_pages p WHERE p.template_id='40' AND p.publish_date < '2023-02-21 07:35:40' AND NOT p.publish_date = '0000-00-00 00:00:00' AND p.parent_id=0
04:35:40.572555Z	 SELECT p.id, p.template_id FROM couch_pages p WHERE p.template_id='40' AND p.publish_date < '2023-02-21 07:35:40' AND NOT p.publish_date = '0000-00-00 00:00:00' AND p.parent_id=0 ORDER BY p.publish_date desc LIMIT 0, 3
04:35:40.573584Z	 SELECT * FROM couch_pages WHERE id='447' AND template_id='40'
04:35:40.574170Z	 SELECT field_id, value FROM couch_data_text WHERE page_id='447'
04:35:40.574734Z	 SELECT field_id, value FROM couch_data_numeric WHERE page_id='447'
04:35:40.575244Z	 SELECT cid FROM couch_relations WHERE pid = '447' AND fid = '11387'
04:35:40.576420Z	 SELECT "------------ CLOCK :: page1-fetched --------"
04:35:40.576985Z	 SELECT * FROM couch_pages WHERE id='424' AND template_id='40'
04:35:40.577582Z	 SELECT field_id, value FROM couch_data_text WHERE page_id='424'
04:35:40.578053Z	 SELECT field_id, value FROM couch_data_numeric WHERE page_id='424'
04:35:40.578904Z	 SELECT "------------ CLOCK :: page2-fetched --------"
04:35:40.579461Z	 SELECT * FROM couch_pages WHERE id='423' AND template_id='40'
04:35:40.580051Z	 SELECT field_id, value FROM couch_data_text WHERE page_id='423'
04:35:40.580542Z	 SELECT field_id, value FROM couch_data_numeric WHERE page_id='423'
04:35:40.581653Z	 SELECT "------------ CLOCK :: page3-fetched --------"
04:35:40.582331Z	 SELECT "------------ CLOCK :: complete --------"
04:35:40.591529Z	 COMMIT
..
```

## Переменные

* **clock**

    Пишется в глобальное пространство переменных.

## Теги в руку

* **show_json**

## Автор

Пишите по любым вопросам

Антон С.\
tony.smirnov@gmail.com
